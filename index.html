<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pavement Distress Mapping</title>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #map {
      flex: 1;
    }
    #capture-controls {
      padding: 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
    }
    video, canvas {
      max-width: 100%;
      height: auto;
      display: block;
      margin-bottom: 10px;
    }
    #points-list {
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: #fafafa;
    }
    #points-list img {
      max-width: 100px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<div id="capture-controls">
  <button onclick="startCamera()">Start Camera</button>
  <button onclick="captureImage()">Capture Image</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display: none;"></canvas>
  <input type="text" id="annotation" placeholder="Enter annotation (optional)">
  <p id="location-info"></p>
</div>

<div id="map"></div>

<div id="points-list"></div>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let annotationInput = document.getElementById('annotation');
let locationInfo = document.getElementById('location-info');
let map, pointsLayer;
let pointsData = [];

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      console.error('Camera error:', err);
    });
}

function captureImage() {
  const context = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageDataURL = canvas.toDataURL('image/jpeg');

  navigator.geolocation.getCurrentPosition(position => {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    const timestamp = new Date().toISOString();
    const annotation = annotationInput.value;

    const pointData = {
      id: Date.now(),
      latitude,
      longitude,
      timestamp,
      annotation,
      imageDataURL
    };

    pointsData.push(pointData);
    addPointToMap(pointData);
    renderPointsList();

    locationInfo.textContent = `Latitude: ${latitude}, Longitude: ${longitude}, Time: ${timestamp}`;
    annotationInput.value = '';
  }, err => {
    console.error('Geolocation error:', err);
  });
}

function initMap() {
  map = L.map('map').setView([22.3191, 87.3195], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  pointsLayer = L.layerGroup().addTo(map);
}

function addPointToMap(pointData) {
  const marker = L.marker([pointData.latitude, pointData.longitude]).addTo(pointsLayer);
  let popupContent = `
    <div style="font-family: 'Inter', sans-serif; font-size: 0.9rem;">
      <strong>Lat:</strong> ${pointData.latitude}<br>
      <strong>Lon:</strong> ${pointData.longitude}<br>
      <strong>Time:</strong> ${pointData.timestamp}<br>
      ${pointData.annotation ? `<strong>Note:</strong> ${pointData.annotation}<br>` : ''}
      ${pointData.imageDataURL ? `<img src="${pointData.imageDataURL}" style="max-width:150px; height:auto; border-radius:0.5rem; margin-top:0.5rem;">` : ''}
    </div>
  `;
  marker.bindPopup(popupContent);
}

function renderPointsList() {
  const container = document.getElementById('points-list');
  container.innerHTML = '';
  pointsData.forEach(point => {
    const listItem = document.createElement('div');
    listItem.style.marginBottom = '1rem';
    listItem.innerHTML = `
      <p><strong>Point ID:</strong> ${point.id}</p>
      <p><strong>Lat/Lon:</strong> ${point.latitude}, ${point.longitude}</p>
      <p><strong>Time:</strong> ${point.timestamp}</p>
      ${point.annotation ? `<p><strong>Note:</strong> ${point.annotation}</p>` : ''}
      ${point.imageDataURL ? `<img src="${point.imageDataURL}" alt="Captured Photo" class="mt-2">` : ''}
    `;
    container.appendChild(listItem);
  });
}

initMap();
</script>
</body>
</html>
